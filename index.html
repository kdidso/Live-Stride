<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LiveStride ‚Äì Satellite Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- MapLibre GL CSS -->
    <link
      href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <!-- Your own CSS -->
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }

      #buttonWrapper {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #controls,
      #modeToggle {
        display: flex;
        gap: 10px;
      }
      #searchBar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        display: none;
      }
      #searchInput {
        padding: 10px;
        font-size: 16px;
        width: 250px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        min-width: 140px;
      }
      button:disabled {
        background-color: #888;
      }

      /* Stats bar: left-aligned, two-line layout */
      #statsBar {
        position: absolute;
        bottom: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 14px;
        padding: 8px 12px;
        text-align: left;
        display: none;
        z-index: 999;
      }

      /* Layer toggle dropdown: positioned above stats bar on left */
      #layerToggle {
        position: absolute;
        bottom: 60px; /* above stats bar */
        left: 10px;
        z-index: 999;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 14px;
      }
      #layerSelect {
        font-size: 14px;
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      /* Recenter button */
      #recenterBtn {
        position: absolute;
        bottom: 37px;
        right: 10px;
        z-index: 999;
        padding: 10px;
        background-color: #28a745;
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        display: none;
        cursor: pointer;
      }

      ul#suggestionsList {
        list-style: none;
        padding: 0;
        margin: 0;
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        background: white;
        border: 1px solid #ccc;
        width: 250px;
      }
      ul#suggestionsList li {
        padding: 10px;
        cursor: pointer;
      }
      ul#suggestionsList li:hover {
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div id="buttonWrapper">
      <div id="modeToggle">
        <button id="runnerModeBtn">üèÉ‚Äç‚ôÇÔ∏è Runner</button>
        <button id="viewerModeBtn">üëÅÔ∏è Viewer</button>
      </div>
      <div id="controls">
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
      <button id="broadcastBtn" style="display: none;">Broadcast</button>
    </div>

    <div id="searchBar">
      <input type="text" id="searchInput" placeholder="Search runner..." />
      <ul id="suggestionsList"></ul>
    </div>

    <!-- Map layer toggle dropdown -->
    <div id="layerToggle">
      <label for="layerSelect">Map:</label>
      <select id="layerSelect">
        <option value="satellite" selected>Satellite</option>
        <option value="streets">Streets</option>
      </select>
    </div>

    <div id="statsBar"></div>
    <button id="recenterBtn">Recenter</button>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

    <!-- Firebase JS -->
    <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-database-compat.js"></script>

    <!-- Capacitor Geolocation plugin will be injected at runtime on Android builds -->
    <script>
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 1) GLOBAL STATE
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let pathCoords = []; // holds objects: { coords: [lon, lat], timestamp, elevation, instPace, avgPace, distance }
      let pollingIntervalId = null;
      let totalDistanceMeters = 0;
      let startTime = null;
      let lastPointTime = null;

      let runnerName = null;
      let broadcastRef = null;
      let broadcasting = false;

      let viewerMarker = null;
      let activeListener = null;
      let selectedRunner = null;

      let isFollowing = true;
      let viewerFollowing = true;

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 2) DOM REFERENCES
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const broadcastBtn = document.getElementById("broadcastBtn");
      const statsBar = document.getElementById("statsBar");
      const recenterBtn = document.getElementById("recenterBtn");
      const searchInput = document.getElementById("searchInput");
      const suggestionsList = document.getElementById("suggestionsList");
      const runnerModeBtn = document.getElementById("runnerModeBtn");
      const viewerModeBtn = document.getElementById("viewerModeBtn");
      const layerSelect = document.getElementById("layerSelect");

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 3) FIREBASE INIT (UNCHANGED)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const firebaseConfig = {
        apiKey: "AIzaSyCHJAjNTplm3eDjAjolmW6U7iPYY0aIWxk",
        authDomain: "livestride.firebaseapp.com",
        databaseURL: "https://livestride-default-rtdb.firebaseio.com",
        projectId: "livestride",
        storageBucket: "livestride.firebasestorage.app",
        messagingSenderId: "758438288478",
        appId: "1:758438288478:web:def85c1fd5e08b6c2ee8cf",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 4) MAP SETUP (UNCHANGED)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const STYLES = {
        satellite:
          "https://api.maptiler.com/maps/satellite/style.json?key=Ii8JoWt1QkDL9pFlSQXC",
        streets:
          "https://api.maptiler.com/maps/streets/style.json?key=Ii8JoWt1QkDL9pFlSQXC",
      };
      let map = new maplibregl.Map({
        container: "map",
        style: STYLES.satellite,
        center: [-113.6, 37.1],
        zoom: 13,
      });
      let navControl, geoControl;
      function addControls() {
        if (navControl) map.removeControl(navControl);
        if (geoControl) map.removeControl(geoControl);

        navControl = new maplibregl.NavigationControl();
        geoControl = new maplibregl.GeolocateControl({
          positionOptions: { enableHighAccuracy: true },
          trackUserLocation: true,
          showAccuracyCircle: false,
          showUserLocation: true,
        });

        map.addControl(navControl, "top-right");
        map.addControl(geoControl, "bottom-right");
      }
      map.on("style.load", addControls);
      map.on("load", () => setMode("runner"));

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 5) UTILITY FUNCTIONS
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function metersToMiles(m) {
        return m / 1609.34;
      }
      function haversineDistance(a, b) {
        const toRad = (x) => (x * Math.PI) / 180;
        const R = 6371000;
        const lat1 = toRad(a[1]),
          lat2 = toRad(b[1]);
        const dLat = toRad(b[1] - a[1]),
          dLng = toRad(b[0] - a[0]);
        const h =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
      }
      function formatTime(ms) {
        const totalSec = Math.floor(ms / 1000);
        const h = String(Math.floor(totalSec / 3600)).padStart(2, "0");
        const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, "0");
        const s = String(totalSec % 60).padStart(2, "0");
        return `${h}:${m}:${s}`;
      }
      function formatPace(minsPerMile) {
        if (!isFinite(minsPerMile) || minsPerMile <= 0) return "‚Äî";
        const m = Math.floor(minsPerMile);
        const s = Math.round((minsPerMile - m) * 60);
        return `${m}:${String(s).padStart(2, "0")} /mi`;
      }
      async function fetchElevation(lat, lon) {
        try {
          const resp = await fetch(
            `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`
          );
          const data = await resp.json();
          if (data && data.results && data.results.length > 0) {
            return data.results[0].elevation; // in meters
          }
        } catch (e) {
          console.error("Elevation fetch error:", e);
        }
        return null;
      }
      function updateStatsDisplay(
        distanceMi,
        instPace,
        avgPace,
        elapsedMs,
        elevationFt
      ) {
        const timeHtml = `Time: ${formatTime(elapsedMs)}`;
        const elevHtml =
          elevationFt != null ? `Elev: ${Math.round(elevationFt)} ft` : "Elev: ‚Äî";

        const distHtml = `Distance: ${distanceMi.toFixed(2)} mi`;
        const paceHtml = `Pace: ${formatPace(instPace)}`;
        const avgHtml = `Avg Pace: ${formatPace(avgPace)}`;

        statsBar.innerHTML = `
          <div>
            ${timeHtml}
            <span style="margin: 0 6px; color: white;">|</span>
            ${elevHtml}
          </div>
          <div style="margin-top:4px;">
            ${distHtml}
            <span style="margin: 0 6px; color: white;">|</span>
            ${paceHtml}
            <span style="margin: 0 6px; color: white;">|</span>
            ${avgHtml}
          </div>`;
      }
      function addOrUpdatePath() {
        const coordsArray = pathCoords.map((p) => p.coords);
        if (!map.getSource("run-path")) {
          map.addSource("run-path", {
            type: "geojson",
            data: {
              type: "Feature",
              geometry: { type: "LineString", coordinates: coordsArray },
            },
          });
          map.addLayer({
            id: "run-line",
            type: "line",
            source: "run-path",
            layout: { "line-join": "round", "line-cap": "round" },
            paint: { "line-color": "#00FFFF", "line-width": 4 },
          });
        } else {
          map.getSource("run-path").setData({
            type: "Feature",
            geometry: { type: "LineString", coordinates: coordsArray },
          });
        }
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 6) RUNNER / VIEWER MODE SWITCH
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function setMode(mode) {
        document.getElementById("controls").style.display =
          mode === "runner" ? "flex" : "none";
        broadcastBtn.style.display = mode === "runner" ? "block" : "none";
        document.getElementById("searchBar").style.display =
          mode === "viewer" ? "block" : "none";
        statsBar.style.display = mode === "viewer" ? "block" : "none";
        recenterBtn.style.display = mode === "viewer" ? "block" : "none";
        isFollowing = viewerFollowing = true;
        map.resize();
      }
      runnerModeBtn.onclick = () => setMode("runner");
      viewerModeBtn.onclick = () => setMode("viewer");

      map.on("dragstart", () => {
        isFollowing = false;
        viewerFollowing = false;
      });
      map.on("zoomstart", () => {
        isFollowing = false;
        viewerFollowing = false;
      });

      recenterBtn.onclick = () => {
        if (viewerMarker) {
          viewerFollowing = true;
          map.flyTo({ center: viewerMarker.getLngLat(), zoom: 16 });
        }
      };

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 7) START TRACKING (Polling @ 1 Hz)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function startTracking() {
        // 1) Clear any existing polling interval
        if (pollingIntervalId !== null) {
          clearInterval(pollingIntervalId);
          pollingIntervalId = null;
        }
        pathCoords = [];
        totalDistanceMeters = 0;
        startTime = null;
        lastPointTime = null;

        startBtn.disabled = true;
        stopBtn.disabled = false;
        statsBar.style.display = "block";

        // 2) Create a 1 Hz polling loop
        pollingIntervalId = setInterval(async () => {
          try {
            let coordsObj = null;
            if (window.CapGeolocation) {
              // Android via Capacitor
              const posRes = await CapGeolocation.getCurrentPosition({
                enableHighAccuracy: true,
                timeout: 1000,
                maximumAge: 0,
              });
              coordsObj = {
                lat: posRes.coords.latitude,
                lon: posRes.coords.longitude,
                timestamp: posRes.timestamp,
              };
            } else {
              // Browser fallback
              coordsObj = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                  (pos) => {
                    resolve({
                      lat: pos.coords.latitude,
                      lon: pos.coords.longitude,
                      timestamp: pos.timestamp,
                    });
                  },
                  (err) => reject(err),
                  { enableHighAccuracy: true, timeout: 1000, maximumAge: 0 }
                );
              });
            }

            const now = coordsObj.timestamp || Date.now();
            const coord = [coordsObj.lon, coordsObj.lat];

            // If this is the very first fix:
            if (pathCoords.length === 0) {
              startTime = now;
              lastPointTime = now;
              pathCoords.push({
                coords: coord,
                timestamp: now,
                elevation: null,
                instPace: 0,
                avgPace: 0,
                distance: 0,
              });
              addOrUpdatePath();
              updateStatsDisplay(0, 0, 0, 0, null);
              return;
            }

            // Otherwise, compute segment distance & paces
            const prevPoint = pathCoords[pathCoords.length - 1];
            const prevCoords = prevPoint.coords;
            const segmentDist = haversineDistance(prevCoords, coord);
            totalDistanceMeters += segmentDist;

            const timeDeltaMin = (now - lastPointTime) / 60000; // minutes
            const instPace =
              segmentDist > 0
                ? timeDeltaMin / (segmentDist / 1609.34)
                : 0;

            const totalTimeMin = (now - startTime) / 60000;
            const avgPace =
              totalDistanceMeters > 0
                ? totalTimeMin / (totalDistanceMeters / 1609.34)
                : 0;

            lastPointTime = now;
            const elevationFt = null; // (you could fetch elevation here)

            const totalTimeMs = now - startTime;

            pathCoords.push({
              coords: coord,
              timestamp: now,
              elevation: null,
              instPace,
              avgPace,
              distance: metersToMiles(totalDistanceMeters),
            });

            addOrUpdatePath();
            updateStatsDisplay(
              metersToMiles(totalDistanceMeters),
              instPace,
              avgPace,
              totalTimeMs,
              elevationFt
            );
          } catch (e) {
            // If getCurrentPosition() times out or fails, just wait for next tick.
            console.warn("GPS polling failed:", e);
          }
        }, 1000 /* 1 000 ms */);
      }
      startBtn.onclick = startTracking;

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 8) STOP TRACKING (clear the polling interval)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function stopTracking() {
        if (pollingIntervalId !== null) {
          clearInterval(pollingIntervalId);
          pollingIntervalId = null;
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
        if (broadcasting && broadcastRef) {
          broadcasting = false;
        }
        // (If you have ‚ÄúExport GPX‚Äù or ‚ÄúUpload to Strava‚Äù buttons,
        //  un-hide them here; for example:)
        // exportGpxBtn.style.display = "inline-block";
        // uploadStravaBtn.style.display = "inline-block";
        // Stats-bar remains visible but stops updating.
      }
      stopBtn.onclick = stopTracking;

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 9) BROADCAST (UNCHANGED)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      broadcastBtn.onclick = () => {
        let first = prompt("Enter your **first name**:")?.trim();
        if (!first || first.length < 2)
          return alert("First name is required.");
        let last = prompt("Enter your **last name**:")?.trim();
        if (!last || last.length < 2) return alert("Last name is required.");

        runnerName = `${first} ${last}`;
        const safeName = `${first}-${last}`
          .toLowerCase()
          .replace(/[^a-z0-9]/g, "-");
        broadcastRef = db.ref(`runners/${safeName}`);
        broadcasting = true;
        broadcastBtn.style.display = "none";

        if (startTime !== null) {
          broadcastRef.set({
            name: runnerName,
            path: pathCoords.map((p) => p.coords),
            current:
              pathCoords.length > 0
                ? pathCoords[pathCoords.length - 1].coords
                : null,
            distance: metersToMiles(totalDistanceMeters),
            pace: 0,
            avgPace: 0,
            timestamp: Date.now(),
            startTime: startTime,
          });
        }
      };

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 10) VIEWER SEARCH & TRACK (UNCHANGED)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      searchInput.addEventListener("input", () => {
        const query = searchInput.value
          .toLowerCase()
          .replace(/[^a-z0-9]/g, "");
        suggestionsList.innerHTML = "";
        if (!query) return;
        db.ref("runners")
          .once("value")
          .then((snapshot) => {
            const all = snapshot.val();
            if (!all) return;
            for (let key in all) {
              const displayName = all[key].name || key;
              if (displayName.toLowerCase().includes(query)) {
                const li = document.createElement("li");
                li.textContent = displayName;
                li.onclick = () => {
                  searchInput.value = displayName;
                  viewerFollowing = true;
                  selectedRunner = key;
                  trackRunner(key);
                  suggestionsList.innerHTML = "";
                };
                suggestionsList.appendChild(li);
              }
            }
          });
      });

      function trackRunner(key) {
        if (activeListener) activeListener.off();
        const ref = db.ref(`runners/${key}`);
        activeListener = ref;
        ref.on("value", async (snap) => {
          const data = snap.val();
          if (!data || !data.current) return;

          if (!viewerMarker) {
            viewerMarker = new maplibregl.Marker({ color: "red" })
              .setLngLat(data.current)
              .addTo(map);
          } else {
            viewerMarker.setLngLat(data.current);
          }

          if (!map.getSource("run-path")) {
            map.addSource("run-path", {
              type: "geojson",
              data: {
                type: "Feature",
                geometry: { type: "LineString", coordinates: data.path || [] },
              },
            });
            map.addLayer({
              id: "run-line",
              type: "line",
              source: "run-path",
              layout: { "line-join": "round", "line-cap": "round" },
              paint: { "line-color": "#00FFFF", "line-width": 4 },
            });
          } else {
            map.getSource("run-path").setData({
              type: "Feature",
              geometry: { type: "LineString", coordinates: data.path || [] },
            });
          }

          const elapsed =
            data.startTime != null && data.timestamp != null
              ? data.timestamp - data.startTime
              : 0;

          let elevationFt = null;
          const [lon, lat] = data.current;
          const elevMeters = await fetchElevation(lat, lon);
          if (elevMeters != null) elevationFt = elevMeters * 3.28084;

          updateStatsDisplay(
            data.distance || 0,
            data.pace || 0,
            data.avgPace || 0,
            elapsed,
            elevationFt
          );

          if (viewerFollowing) {
            map.flyTo({ center: data.current, zoom: 16 });
          }
        });
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // 11) MAP LAYER TOGGLE (UNCHANGED)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      layerSelect.addEventListener("change", () => {
        const chosen = layerSelect.value; // "satellite" or "streets"
        const newStyle = STYLES[chosen] || STYLES.satellite;
        map.setStyle(newStyle);
        // Controls will be re-added in 'style.load' handler
      });
    </script>
  </body>
</html>
