<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js"></script>
<script>
  // Firebase config and init
  const firebaseConfig = {
    apiKey: "AIzaSyCHJAjNTplm3eDjAjolmW6U7iPYY0aIWxk",
    authDomain: "livestride.firebaseapp.com",
    databaseURL: "https://livestride-default-rtdb.firebaseio.com",
    projectId: "livestride",
    storageBucket: "livestride.firebasestorage.app",
    messagingSenderId: "758438288478",
    appId: "1:758438288478:web:def85c1fd5e08b6c2ee8cf"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Everything below is your original app logic — no change needed yet
  const maptilerKey = 'Ii8JoWt1QkDL9pFlSQXC';
  const map = new maplibregl.Map({
    container: 'map',
    style: `https://api.maptiler.com/maps/satellite/style.json?key=${maptilerKey}`,
    center: [-113.6, 37.1],
    zoom: 13
  });

  map.addControl(new maplibregl.NavigationControl());

  const geoControl = new maplibregl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true,
    showAccuracyCircle: false,
    showUserLocation: true
  });
  map.addControl(geoControl, 'bottom-right');

  let pathCoords = [];
  let lineSourceId = 'run-path';
  let lineLayerId = 'run-line';
  let userMarker = null;
  let watchId = null;
  let startTime = null;
  let lastPointTime = null;
  let totalDistanceMeters = 0;

  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const statsBar = document.getElementById('statsBar');

  function metersToMiles(meters) {
    return meters / 1609.34;
  }

  function haversineDistance(coord1, coord2) {
    const toRad = x => x * Math.PI / 180;
    const R = 6371000;
    const lat1 = toRad(coord1[1]);
    const lat2 = toRad(coord2[1]);
    const deltaLat = toRad(coord2[1] - coord1[1]);
    const deltaLng = toRad(coord2[0] - coord1[0]);
    const a = Math.sin(deltaLat/2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLng/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function formatPace(minsPerMile) {
    if (!isFinite(minsPerMile) || minsPerMile <= 0) return "—";
    const minutes = Math.floor(minsPerMile);
    const seconds = Math.round((minsPerMile - minutes) * 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')} /mi`;
  }

  function updateStatsDisplay(distanceMiles, instPace, avgPace) {
    statsBar.innerHTML = `
      Distance: ${distanceMiles.toFixed(2)} mi &nbsp; | &nbsp;
      Pace: ${formatPace(instPace)} &nbsp; | &nbsp;
      Avg Pace: ${formatPace(avgPace)}
    `;
    statsBar.style.display = 'block';
  }

  function addOrUpdatePath() {
    if (!map.getSource(lineSourceId)) {
      map.addSource(lineSourceId, {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: pathCoords
          }
        }
      });

      map.addLayer({
        id: lineLayerId,
        type: 'line',
        source: lineSourceId,
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': '#00FFFF',
          'line-width': 4
        }
      });
    } else {
      map.getSource(lineSourceId).setData({
        type: 'Feature',
        geometry: {
          type: 'LineString',
          coordinates: pathCoords
        }
      });
    }
  }

  function startTracking() {
    pathCoords = [];
    totalDistanceMeters = 0;
    startTime = null;
    lastPointTime = null;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    map.removeControl(geoControl);
    statsBar.style.display = 'block';

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;
        const now = Date.now();
        const coord = [lng, lat];

        if (!userMarker) {
          userMarker = new maplibregl.Marker({ color: 'red' })
            .setLngLat(coord)
            .addTo(map);
          map.flyTo({ center: coord, zoom: 16 });
        } else {
          userMarker.setLngLat(coord);
        }

        if (pathCoords.length > 0) {
          const prev = pathCoords[pathCoords.length - 1];
          const timeDeltaMin = (now - lastPointTime) / 60000;
          const segmentDist = haversineDistance(prev, coord);
          const instPace = timeDeltaMin / metersToMiles(segmentDist);

          totalDistanceMeters += segmentDist;
          const totalTimeMin = (now - startTime) / 60000;
          const avgPace = totalTimeMin / metersToMiles(totalDistanceMeters);

          updateStatsDisplay(metersToMiles(totalDistanceMeters), instPace, avgPace);
        } else {
          startTime = now;
        }

        lastPointTime = now;
        pathCoords.push(coord);
        addOrUpdatePath();
      },
      (err) => {
        console.error("Geolocation error:", err);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000
      }
    );
  }

  function stopTracking() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
    map.addControl(geoControl, 'bottom-right');
  }

  startBtn.addEventListener('click', startTracking);
  stopBtn.addEventListener('click', stopTracking);
</script>
